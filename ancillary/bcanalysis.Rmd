---
title: "Bactocap Analysis"
output:
  html_document: default
  pdf_document: default
---
```{r rsetup, warning = FALSE, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rstudioapi)
library(reticulate)
library(tidyverse)
library(GGally)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```
```{python pysetup, warning = FALSE, echo = FALSE, message = FALSE}
import numpy as np
import pandas as pd
import itertools as it
```

This MD incorporates the various analyses I've done for the Bactocap project in one place. We are trying to assess the outcome of a targeted sequence capture method described in ***this manuscript***. In order to do that, I am measuring 'success' of capture in a number of ways, including: the total number of baits captured and sequenced to a give d.o.c, and then assessing the effect of various laboratory metrics on the proportion of baits captured to a given d.o.c. More below.

A note on the programming. I really love R's tidyverse and plotting capabilities, but I prefer Python for scripting (and almost everything else). I found the `reticulate` library that allows interoperability and the sharing of states between R and Python code, which in turn has allowed me to combine my R and Python scripts into one .Rmd file. 

I'm not sure whether the result is a monster or not:

![](ancillary/misc/could-should.jpg)

But it's achieved what I want. 

I probably could have just written this whole thing in one or the other, but where's the fun in that?
```{python getdata, include = FALSE}
andata = pd.read_csv("/Users/tristanpwdennis/Projects/bactocap/datasets/anthrax/results/0to400covstats.txt", sep=' ', names=["num_baits", "sample", "depth"]) 
mydata = pd.read_csv("/Users/tristanpwdennis/Projects/bactocap/datasets/mycoplasma/covstatstotal.txt", sep=' ', names=["num_baits", "sample", "depth"])
mymeta = pd.read_csv("/Users/tristanpwdennis/Projects/bactocap/datasets/mycoplasma/myco-seq-sample-data.csv")
anmeta = pd.read_csv("/Users/tristanpwdennis/Projects/bactocap/datasets/anthrax/anthrax-metadata-ud1.csv")
```




**Part 1: Calculating the per-sample fraction of the baitset covered to a minimum d.o.c**

The minimum coverage over each bait over a range of d.o.c (0-400 in increments of 5) was calculated per-sample using the script below (won't run at the moment)
The script will print and count the number of baits in a sample's coverage file that have 1 or more positions below an incrementing d.o.c.
```{bash cov, eval = FALSE}
for f in *total.txt #where *.total.txt takes the output files of bedtools genomecov
do
	for i in `seq 0 5 400` #stepwise coverage increments
	do
		echo `awk -v num=$i '$6 < num {print$4}' $f | uniq | wc -l ` `basename $f .total.txt` $i >> covstats.txt
	done
done
```
Then we take that output, add the metadata for each sample set, and calculate the baits captured to min. d.o.c as a fraction of the total for that set
```{python wrangle}
def wrangle(datafile, metadatafile, numbaits): 
    colval = pd.Series([len(metadatafile.index) for i in range(len(datafile.index))])
    datafile.insert(loc = 0, column = 'ninds', value = colval)
    datafile['frac'] = (numbaits - (datafile['num_baits']))/numbaits
    datafile['organism'] = np.where(datafile['ninds']==113, 'anthrax', 'mycoplasma')
    return(datafile)
#wrangle from our inputs, then bind together and add organism names
fdf = pd.concat([wrangle(mydata, mymeta, 24444), wrangle(andata, anmeta, 148729)])
```
Here's the head of the dataframe 'fdf' that we produce
```{python head1, echo = FALSE}
fdf.head()
```
Plot in ggplot2
```{r indfrac, echo = FALSE, warning = FALSE, fig.cap="Figure 1. Fraction of baits captured across the whole baitset, to increasing depths of coverage. Line colour denotes individual sample"}
py$fdf %>% ggplot(aes(x=depth, y =frac, colour=sample)) +
    geom_line(show.legend = FALSE) +
    facet_wrap(~organism) +
    scale_colour_discrete() +
    xlab("Depth of Coverage") +
    ylab("Fraction of Baits Captured") +
    theme(legend.position = "none") +
    theme_minimal()

```
**Part 2: Calculating the fraction of the sample set with an increasing fraction of the total baitset covered to a minimum d.o.c**

Next, I want to find the number of individuals with a given fraction of baits covered to a given depth of coverage, for both organisms. So I create the cartesian product of: fraction of total baitset (0-1 in 0.1 increments) and minimum depth of coverage over a bait (0 to 400 in increments of 10)
```{python covfrac}
#intialise empty dataframe
size_df = pd.DataFrame(columns=["frac", "coverage", "ninds", "size"])
#Create the cartesian product of these ranges, expand them into a triplet in a for loop and iterate over them all (3-way nested loop)
#the count the number of rows matching each combination of conditions, populating a dataframe with the result
for f, c, i in it.product(np.arange(0.1,1.0,0.1), np.arange(0,410,10),[113, 56]):
    mask = (fdf.frac > f) & (fdf.depth == c) & (fdf.ninds == i)
    size = mask.sum()
    size_df.loc[len(size_df)] = [f, c, i, size]

#get the fraction of individuals per sample set by dividing the number of individuals matching each condition
size_df['frac_inds'] = size_df['size']/size_df['ninds']
#add organism name for ninds as above , based on the number of individuals in each sample set
size_df['organism'] = np.where(size_df['ninds']==113, 'anthrax', 'mycoplasma')
```
Here's the head of the dataframe 'size_df' that we produce
```{python head2, echo = FALSE}
size_df.head()
```
Now let's plot in ggplot2
```{r plotcovfrac, echo = FALSE, fig.cap="Figure 2. Fraction of individuals in each sampleset that have an increasing fraction of the total baitset (in 10% increments, indicated by the plot's windows) captured to an increasing d.o.c"}
py$size_df %>% 
  ggplot(., aes(x=coverage, y = frac_inds, colour = organism)) +
  geom_line() +
  xlab("Minimum Depth of Coverage Of Total Capture") +
  ylab("Fraction of Individuals") +
  facet_wrap(~frac) +
  theme_minimal()
```
```{r plotstats, echo = FALSE}
#add organism columns to metadata
py$anmeta$organism <- paste0("anthrax")
py$mymeta$organism <- paste0("mycoplasma")

py$anmeta$frac_mapped = py$an$meta$mapped/py$an$meta$reads
py$mymeta$frac_mapped = py$my$meta$mapped/py$my$meta$reads

py$anmeta %>% select(cap_lib_conc, init_lib_conc, reads,frac_mapped, frac_duplicates, max_ct) %>% ggpairs()
py$mymeta %>% select(cap_lib_conc, init_lib_conc, reads,frac_mapped, frac_duplicates, max_ct) %>% ggpairs()



```







